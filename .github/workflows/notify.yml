name: Notify Discord on GitHub Issue Events

on:
  issues:
    types: [opened, closed]

jobs:
  notify-discord:
    runs-on: ubuntu-latest

    steps:
      - name: Send issue event to Discord
        env:
          DISCORD_WEBHOOK: ${{ secrets.DISCORD_WEBHOOK }}
          DISCORD_WEBHOOK_2: ${{ secrets.DISCORD_WEBHOOK_2 }}
          ISSUE_ACTION: ${{ github.event.action }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          ISSUE_USER: ${{ github.event.issue.user.login }}
        run: |
          echo "Extracting issue number..."
          ISSUE_NUMBER=$(echo "$ISSUE_URL" | awk -F'/' '{print $NF}')
          CUSTOM_URL="https://status.dev.slce.moe/incident/$ISSUE_NUMBER"

          if [ "$ISSUE_ACTION" = "closed" ]; then
            DISPLAY_TITLE="[RESOLVED] $ISSUE_TITLE"
          else
            DISPLAY_TITLE="$ISSUE_TITLE"
          fi

          MESSAGE="$(jq -n \
            --arg title "$ISSUE_TITLE" \
            --arg action "$ISSUE_ACTION" \
            --arg user "$ISSUE_USER" \
            --arg url "$CUSTOM_URL" \
            '{content: "\($title)\n\n\($action) by \@($user)\nURL: \($url)"}')"

          echo "Sending Discord notification 1..."
          curl -X POST "$DISCORD_WEBHOOK" \
            -H "Content-Type: application/json" \
            -d "$MESSAGE"

          echo "Sending Discord notification 2..."
          curl -X POST "$DISCORD_WEBHOOK_2" \
            -H "Content-Type: application/json" \
            -d "$MESSAGE"

          echo "Notifications sent successfully."
